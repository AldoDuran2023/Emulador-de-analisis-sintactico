<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compilador JS - Final (Con Comparaciones)</title>
    <style>
      :root {
        --bg-color: #1e1e1e;
        --sidebar-bg: #252526;
        --text-color: #d4d4d4;
        --accent: #007acc;
        --border: #3c3c3c;
        --tree-line-color: #555;
        --node-bg: #ffffff;
        --node-border: #000000;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        width: 100%;
        height: 100%;
      }
      .editor-section {
        width: 35%;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border);
      }
      .output-section {
        width: 65%;
        display: flex;
        flex-direction: column;
        background-color: var(--sidebar-bg);
      }

      .toolbar {
        padding: 10px;
        background-color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
      }
      h1 {
        margin: 0;
        font-size: 1rem;
        color: #fff;
      }
      button {
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 3px;
        font-weight: bold;
      }
      button:hover {
        background-color: #0062a3;
      }

      textarea {
        flex: 2;
        background-color: var(--bg-color);
        color: var(--text-color);
        border: none;
        padding: 15px;
        font-family: "Consolas", monospace;
        resize: none;
        outline: none;
        font-size: 14px;
        line-height: 1.5;
        border-bottom: 1px solid var(--border);
      }

      .grammar-panel {
        flex: 1;
        background-color: #2d2d2d;
        padding: 10px;
        font-family: "Consolas", monospace;
        font-size: 0.8rem;
        overflow-y: auto;
        color: #8fa;
      }
      .grammar-title {
        color: #fff;
        margin-bottom: 5px;
        font-weight: bold;
        border-bottom: 1px solid #444;
        padding-bottom: 2px;
      }

      .tabs {
        display: flex;
        background-color: #333;
        border-bottom: 1px solid var(--border);
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-right: 1px solid var(--border);
        opacity: 0.7;
        font-size: 0.9rem;
      }
      .tab.active {
        background-color: var(--sidebar-bg);
        opacity: 1;
        border-top: 2px solid var(--accent);
        font-weight: bold;
      }

      .panel {
        flex: 1;
        padding: 0;
        overflow: auto;
        display: none;
        position: relative;
      }
      .panel.active {
        display: block;
      }

      /* Estilos del Árbol */
      .tree-container {
        width: 100%;
        min-height: 100%;
        text-align: center;
        padding: 40px 20px;
        background-color: #fff;
        background-image: radial-gradient(#ddd 1px, transparent 1px);
        background-size: 20px 20px;
        white-space: nowrap;
        overflow: auto;
      }

      .tree ul {
        padding-top: 20px;
        position: relative;
        display: flex;
        justify-content: center;
        margin: 0;
        padding-left: 0;
      }
      .tree li {
        float: left;
        text-align: center;
        list-style-type: none;
        position: relative;
        padding: 20px 10px 0 10px;
      }

      .tree li::before,
      .tree li::after {
        content: "";
        position: absolute;
        top: 0;
        right: 50%;
        border-top: 2px solid var(--tree-line-color);
        width: 50%;
        height: 20px;
      }
      .tree li::after {
        right: auto;
        left: 50%;
        border-left: 2px solid var(--tree-line-color);
      }
      .tree li:only-child::after,
      .tree li:only-child::before {
        display: none;
      }
      .tree li:only-child {
        padding-top: 0;
      }
      .tree li:first-child::before,
      .tree li:last-child::after {
        border: 0 none;
      }
      .tree li:last-child::before {
        border-right: 2px solid var(--tree-line-color);
        border-radius: 0 5px 0 0;
      }
      .tree li:first-child::after {
        border-radius: 5px 0 0 0;
      }
      .tree ul ul::before {
        content: "";
        position: absolute;
        top: 0;
        left: 50%;
        border-left: 2px solid var(--tree-line-color);
        width: 0;
        height: 20px;
      }

      .node-content {
        border: 2px solid var(--node-border);
        padding: 8px 12px;
        text-decoration: none;
        color: var(--node-text);
        background-color: var(--node-bg);
        font-family: "Arial", sans-serif;
        font-size: 14px;
        font-weight: bold;
        display: inline-block;
        border-radius: 20px;
        min-width: 30px;
        position: relative;
        z-index: 10;
        box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.1);
      }
      .node-sub {
        display: block;
        font-size: 0.7em;
        color: #555;
        font-weight: normal;
        margin-top: 2px;
      }

      .node-content.error-node {
        background-color: #ffcccc;
        border-color: #cc0000;
        color: #cc0000;
        border-radius: 4px;
      }

      .log-entry {
        padding: 8px;
        border-bottom: 1px solid #333;
        font-family: "Consolas";
        font-size: 0.9rem;
      }
      .log-error {
        color: #ff6b6b;
        background: rgba(255, 0, 0, 0.1);
        border-left: 4px solid red;
      }
      .log-success {
        color: #89d185;
        border-left: 4px solid green;
      }

      /* Estilos Tabla Tokens */
      .token-panel-content {
        padding: 20px;
        background-color: #f0f2f5;
        min-height: 100%;
        box-sizing: border-box;
      }
      .token-table {
        width: 100%;
        border-collapse: collapse;
        font-family: "Segoe UI", sans-serif;
        font-size: 0.95rem;
        background-color: #ffffff;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        color: #333;
      }
      .token-table thead tr {
        background-color: #1c5298;
        color: #ffffff;
        text-align: left;
      }
      .token-table th,
      .token-table td {
        padding: 12px 15px;
        border: 1px solid #e1e4e8;
      }
      .token-table th {
        border-color: #1c5298;
      }
      .token-table tbody tr:nth-of-type(even) {
        background-color: #f2f6fc;
      }
      .col-token {
        color: #1c5298;
        font-weight: bold;
        width: 30%;
      }
      .col-lexema {
        color: #d63384;
        font-family: "Consolas", monospace;
        font-weight: bold;
        width: 30%;
      }
      .col-patron {
        color: #333;
        width: 40%;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="editor-section">
        <div class="toolbar">
          <h1>Compilador JS (Corregido)</h1>
          <button onclick="compile()">COMPILAR ▶</button>
        </div>
        <textarea
          id="code"
          spellcheck="false"
          placeholder="// Escribe tu código aquí..."
        >
let a = 10;
let b = 5;

// Cálculo básico
let x = a + b * 2; 

if (x > 15) {
   a = 0;
}
</textarea
        >
        <div class="grammar-panel">
          <div class="grammar-title">GRAMÁTICA & REGLAS</div>
          <div style="color: #6a9955">IGNORADO: // Comentarios</div>
          <div>-----------------------------------</div>
          <div style="color: #569cd6">Comparación → Exp (>|<|==) Exp</div>
          <div style="color: #4ec9b0">Expression → Term { (+|-) Term }</div>
          <div style="color: #ce9178">Term → Factor { (*|/) Factor }</div>
          <div style="color: #dcdcaa">Factor → ( Expr ) | ID | NUM</div>
          <div>-----------------------------------</div>
          <div>Prioridad: ( ) > * / > + - > Comparación</div>
        </div>
      </div>

      <div class="output-section">
        <div class="tabs">
          <div class="tab active" onclick="showTab('ast')">
            Árbol Sintáctico (AST)
          </div>
          <div class="tab" onclick="showTab('console')">Consola / Errores</div>
          <div class="tab" onclick="showTab('tokens')">Tokens (Tabla)</div>
        </div>

        <div id="ast" class="panel active">
          <div class="tree-container">
            <div class="tree" id="ast-view"></div>
          </div>
        </div>
        <div id="console" class="panel"><div id="console-content"></div></div>
        <div id="tokens" class="panel">
          <div id="tokens-content" class="token-panel-content"></div>
        </div>
      </div>
    </div>

    <script>
      // --- 1. LEXER ---
      const TokenType = {
        KEYWORD: "KEYWORD",
        ID: "ID",
        NUM: "NUM",
        OP: "OP",
        PUNC: "PUNC",
        EOF: "EOF",
      };

      const TokenInfo = {
        [TokenType.KEYWORD]: {
          nombre: "Palabra reservada",
          patron: "Reservada",
        },
        [TokenType.ID]: { nombre: "Identificador", patron: "Identificador" },
        [TokenType.NUM]: { nombre: "Número", patron: "Num" },
        [TokenType.OP]: { nombre: "Operador", patron: "Operador" },
        [TokenType.PUNC]: { nombre: "Signo puntuacion", patron: "Signo" },
        [TokenType.EOF]: { nombre: "Fin de archivo", patron: "EOF" },
      };

      class Lexer {
        constructor(input) {
          this.input = input;
          this.pos = 0;
          this.line = 1;
        }

        tokenize() {
          let tokens = [];
          while (this.pos < this.input.length) {
            let char = this.input[this.pos];

            // Comentarios
            if (char === "/") {
              const next = this.input[this.pos + 1];
              if (next === "/") {
                this.pos += 2;
                while (
                  this.pos < this.input.length &&
                  this.input[this.pos] !== "\n"
                )
                  this.pos++;
                continue;
              }
              if (next === "*") {
                this.pos += 2;
                while (this.pos < this.input.length) {
                  if (
                    this.input[this.pos] === "*" &&
                    this.input[this.pos + 1] === "/"
                  ) {
                    this.pos += 2;
                    break;
                  }
                  if (this.input[this.pos] === "\n") this.line++;
                  this.pos++;
                }
                continue;
              }
            }

            if (/\s/.test(char)) {
              if (char === "\n") this.line++;
              this.pos++;
              continue;
            }

            if (/[0-9]/.test(char)) {
              let num = "";
              while (
                this.pos < this.input.length &&
                /[0-9]/.test(this.input[this.pos])
              )
                num += this.input[this.pos++];
              tokens.push({ type: TokenType.NUM, value: num, line: this.line });
              continue;
            }

            if (/[a-zA-Z_]/.test(char)) {
              let id = "";
              while (
                this.pos < this.input.length &&
                /[a-zA-Z0-9_]/.test(this.input[this.pos])
              )
                id += this.input[this.pos++];
              const isKw = ["let", "if", "else", "function"].includes(id);
              tokens.push({
                type: isKw ? TokenType.KEYWORD : TokenType.ID,
                value: id,
                line: this.line,
              });
              continue;
            }

            // Operadores (incluyendo comparación de varios caracteres)
            const twoChar = this.input.substr(this.pos, 2);
            if (["==", ">=", "<=", "!="].includes(twoChar)) {
              tokens.push({
                type: TokenType.OP,
                value: twoChar,
                line: this.line,
              });
              this.pos += 2;
              continue;
            }

            if (/[+\-*/=><]/.test(char)) {
              tokens.push({ type: TokenType.OP, value: char, line: this.line });
              this.pos++;
              continue;
            }

            if (/[(){};]/.test(char)) {
              tokens.push({
                type: TokenType.PUNC,
                value: char,
                line: this.line,
              });
              this.pos++;
              continue;
            }

            this.pos++;
          }
          tokens.push({ type: TokenType.EOF, value: "EOF", line: this.line });
          return tokens;
        }
      }

      // --- 2. PARSER ---
      class Parser {
        constructor(tokens) {
          this.tokens = tokens;
          this.current = 0;
          this.errors = [];
        }
        peek() {
          return this.tokens[this.current];
        }

        consume(type, val) {
          const t = this.peek();
          if (t.type === type && (!val || t.value === val)) {
            this.current++;
            return t;
          }
          throw new Error(
            `Error de Sintaxis (Línea ${t.line}): Se esperaba '${
              val || type
            }' pero se encontró '${t.value}'`
          );
        }

        parse() {
          const body = [];
          while (this.peek().type !== TokenType.EOF) {
            try {
              body.push(this.parseStatement());
            } catch (e) {
              this.errors.push(e.message);
              body.push({ type: "ERROR_NODE", message: e.message });
              this.synchronize();
            }
          }
          return { type: "Program", body };
        }

        synchronize() {
          while (
            this.peek().type !== TokenType.EOF &&
            this.peek().value !== ";"
          )
            this.current++;
          if (this.peek().value === ";") this.current++;
        }

        parseStatement() {
          const t = this.peek();
          if (t.type === TokenType.KEYWORD && t.value === "let") {
            this.consume(TokenType.KEYWORD);
            const id = this.consume(TokenType.ID).value;
            this.consume(TokenType.OP, "=");
            const init = this.parseExpression(); // <--- Ahora llama al nivel superior (Comparación)
            this.consume(TokenType.PUNC, ";");
            return { type: "VarDecl", id, init };
          }
          if (t.type === TokenType.KEYWORD && t.value === "if") {
            this.consume(TokenType.KEYWORD);
            this.consume(TokenType.PUNC, "(");
            const test = this.parseExpression(); // <--- Esto permite x > 15
            this.consume(TokenType.PUNC, ")");
            this.consume(TokenType.PUNC, "{");
            const cons = [];
            while (
              this.peek().value !== "}" &&
              this.peek().type !== TokenType.EOF
            )
              cons.push(this.parseStatement());
            this.consume(TokenType.PUNC, "}");
            return { type: "If", test, body: cons };
          }
          if (t.type === TokenType.ID) {
            const id = this.consume(TokenType.ID).value;
            this.consume(TokenType.OP, "=");
            const right = this.parseExpression();
            this.consume(TokenType.PUNC, ";");
            return { type: "Assign", left: id, right };
          }
          throw new Error(
            `Instrucción no reconocida en línea ${t.line}: '${t.value}'`
          );
        }

        // NIVEL 1: COMPARACIONES (Menor prioridad, se ejecuta al final)
        parseExpression() {
          let left = this.parseAddition(); // Llama a suma/resta primero
          while (
            [">", "<", ">=", "<=", "==", "!="].includes(this.peek().value)
          ) {
            const operator = this.consume(TokenType.OP).value;
            const right = this.parseAddition();
            left = { type: "Binary", operator, left, right };
          }
          return left;
        }

        // NIVEL 2: SUMA / RESTA
        parseAddition() {
          let left = this.parseTerm();
          while (this.peek().value === "+" || this.peek().value === "-") {
            const operator = this.consume(TokenType.OP).value;
            const right = this.parseTerm();
            left = { type: "Binary", operator, left, right };
          }
          return left;
        }

        // NIVEL 3: MULTIPLICACIÓN / DIVISIÓN
        parseTerm() {
          let left = this.parseFactor();
          while (this.peek().value === "*" || this.peek().value === "/") {
            const operator = this.consume(TokenType.OP).value;
            const right = this.parseFactor();
            left = { type: "Binary", operator, left, right };
          }
          return left;
        }

        // NIVEL 4: FACTORES (Números, IDs, Paréntesis)
        parseFactor() {
          const t = this.peek();
          if (t.type === TokenType.NUM) {
            this.consume(TokenType.NUM);
            return { type: "Literal", value: t.value };
          }
          if (t.type === TokenType.ID) {
            this.consume(TokenType.ID);
            return { type: "ID", name: t.value };
          }
          if (t.value === "(") {
            this.consume(TokenType.PUNC, "(");
            const expr = this.parseExpression(); // Recursividad al nivel más alto
            this.consume(TokenType.PUNC, ")");
            return expr;
          }
          throw new Error(`Se esperaba Expresión, se encontró '${t.value}'`);
        }
      }

      // --- 3. RENDERIZADO ---
      function createNode(label, sub, type) {
        const div = document.createElement("div");
        div.className = "node-content";
        if (type === "ERROR_NODE") div.className += " error-node";
        div.innerHTML =
          label + (sub ? `<span class="node-sub">${sub}</span>` : "");
        return div;
      }

      function renderTree(node) {
        if (!node) return null;
        const li = document.createElement("li");
        let label = node.type,
          sub = "",
          children = [];

        switch (node.type) {
          case "Program":
            label = "Program";
            children = node.body;
            break;
          case "VarDecl":
            label = "Var";
            sub = node.id;
            children = [node.init];
            break;
          case "Assign":
            label = "=";
            sub = "assign";
            children = [{ type: "ID_REF", name: node.left }, node.right];
            break;
          case "Binary":
            label = node.operator;
            sub = "op";
            children = [node.left, node.right];
            break;
          case "Literal":
            label = node.value;
            sub = "num";
            break;
          case "ID":
            label = node.name;
            sub = "id";
            break;
          case "ID_REF":
            label = node.name;
            sub = "ref";
            break;
          case "If":
            label = "IF";
            children = [node.test, { type: "Block", body: node.body }];
            break;
          case "Block":
            label = "{ }";
            children = node.body;
            break;
          case "ERROR_NODE":
            label = "ERROR";
            sub = "Sintaxis";
            break;
        }

        li.appendChild(createNode(label, sub, node.type));
        if (children && children.length) {
          const ul = document.createElement("ul");
          children.forEach((c) => {
            const childLi = renderTree(c);
            if (childLi) ul.appendChild(childLi);
          });
          li.appendChild(ul);
        }
        return li;
      }

      // --- 4. APP ---
      function compile() {
        const code = document.getElementById("code").value;
        const consoleEl = document.getElementById("console-content");
        const astEl = document.getElementById("ast-view");
        const tokensEl = document.getElementById("tokens-content");
        consoleEl.innerHTML = "";
        astEl.innerHTML = "";
        tokensEl.innerHTML = "";

        try {
          const lexer = new Lexer(code);
          const tokens = lexer.tokenize();

          // Tabla visual
          let tableHtml = `<table class="token-table"><thead><tr><th>Token</th><th>Lexema</th><th>Patrón</th></tr></thead><tbody>`;
          const vistos = new Set();
          tokens.forEach((t) => {
            if (t.type !== "EOF" && !vistos.has(t.value)) {
              vistos.add(t.value);
              const info = TokenInfo[t.type] || { nombre: t.type, patron: "-" };
              tableHtml += `<tr><td class="col-token">${info.nombre}</td><td class="col-lexema">${t.value}</td><td class="col-patron">${info.patron}</td></tr>`;
            }
          });
          tokensEl.innerHTML = tableHtml + "</tbody></table>";

          const parser = new Parser(tokens);
          const ast = parser.parse();
          const root = document.createElement("ul");
          root.appendChild(renderTree(ast));
          astEl.appendChild(root);

          if (parser.errors.length > 0) {
            consoleEl.innerHTML += `<div class="log-entry log-error"><b>Se encontraron ${parser.errors.length} errores:</b></div>`;
            parser.errors.forEach(
              (err) =>
                (consoleEl.innerHTML += `<div class="log-entry log-error">❌ ${err}</div>`)
            );
            showTab("console");
          } else {
            consoleEl.innerHTML += `<div class="log-entry log-success">✅ Compilación exitosa. Código procesado.</div>`;
          }
        } catch (e) {
          consoleEl.innerHTML = `<div class="log-entry log-error">Error Crítico: ${e.message}</div>`;
        }
      }

      function showTab(id) {
        document
          .querySelectorAll(".panel")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        const tabs = document.querySelectorAll(".tab");
        if (id === "ast") tabs[0].classList.add("active");
        if (id === "console") tabs[1].classList.add("active");
        if (id === "tokens") tabs[2].classList.add("active");
      }

      setTimeout(compile, 500);
    </script>
  </body>
</html>
